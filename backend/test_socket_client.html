<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Test Cliente Socket - Escuchar Coordenadas</title>
    <style>
        body { 
            font-family: monospace; 
            background: #1a1a1a; 
            color: #00ff00; 
            padding: 20px; 
            line-height: 1.4;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { 
            background: #2a2a2a; 
            border: 1px solid #00ff00; 
            border-radius: 8px; 
            padding: 15px; 
            margin: 10px 0; 
        }
        .button { 
            background: #00ff00; 
            color: #000; 
            border: none; 
            padding: 8px 15px; 
            margin: 5px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold;
        }
        .button:hover { background: #00dd00; }
        .log { 
            background: #000; 
            border: 1px solid #333; 
            border-radius: 4px; 
            padding: 10px; 
            height: 300px; 
            overflow-y: auto; 
            font-size: 12px;
            white-space: pre-wrap;
        }
        .status { font-weight: bold; padding: 5px; }
        .connected { color: #00ff00; }
        .disconnected { color: #ff0000; }
        .coords { color: #ffff00; background: #444; padding: 2px 5px; border-radius: 3px; }
    </style>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>üîç Test Cliente Socket - Escuchar Coordenadas</h1>
        
        <div class="section">
            <h3>üéØ Test de Escucha en Tiempo Real</h3>
            <p><strong>Objetivo:</strong> Verificar si un cliente puede escuchar las coordenadas enviadas por el chofer</p>
            <p><strong>Ruta monitoreada:</strong> Ruta B (f206dc92-2a2f-4bcf-9a6e-799d6b83033d)</p>
            <p><strong>Micro ABC123:</strong> b9dcd6a8-a054-47c1-98a6-9c9dadbc6a2a</p>
            
            <div class="status" id="connectionStatus">‚ùå Desconectado</div>
            
            <button class="button" onclick="connectAsClient()">üîå Conectar como Cliente</button>
            <button class="button" onclick="disconnect()">‚ùå Desconectar</button>
            <button class="button" onclick="joinRoute()">üõ£Ô∏è Unirse a Ruta B</button>
            <button class="button" onclick="clearLog()">üßπ Limpiar Log</button>
        </div>

        <div class="section">
            <h3>üìç √öltimas Coordenadas Recibidas</h3>
            <div id="lastCoords">
                <p>Esperando datos...</p>
            </div>
        </div>

        <div class="section">
            <h3>üì® Log de Eventos</h3>
            <div class="log" id="eventLog"></div>
        </div>
    </div>

    <script>
        let socket = null;
        let isConnected = false;
        let lastUpdate = null;

        // Credenciales reales del sistema
        const CREDENTIALS = {
            microId: 'b9dcd6a8-a054-47c1-98a6-9c9dadbc6a2a',
            token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI4ZTY4ZDE2Mi01ZDJmLTRkZDctOWI1Zi03MTgzZDQ0ZDY1MDAiLCJpYXQiOjE3NTA0NjE3NzUsImV4cCI6MTc1MTMyNTc3NX0.-7u5mNBo9HheUJ7XbAAVxisgW5GASNQtTb0CRB6o2W8',
            routeId: 'f206dc92-2a2f-4bcf-9a6e-799d6b83033d'
        };

        const SERVER_URL = 'ws://54.82.231.172:3001/tracking';

        function log(message) {
            const now = new Date().toLocaleTimeString();
            const logElement = document.getElementById('eventLog');
            logElement.textContent += `${now} - ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${now}] ${message}`);
        }

        function updateStatus(status, isConnected) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = status;
            statusElement.className = isConnected ? 'status connected' : 'status disconnected';
        }

        function updateCoords(data) {
            const coordsElement = document.getElementById('lastCoords');
            const timestamp = new Date().toLocaleString();
            
            coordsElement.innerHTML = `
                <div class="coords">
                    <strong>üìç Lat:</strong> ${data.latitud}<br>
                    <strong>üìç Lng:</strong> ${data.longitud}<br>
                    <strong>üöå Micro:</strong> ${data.id_micro}<br>
                    <strong>‚è∞ Recibido:</strong> ${timestamp}<br>
                    <strong>üîã Bater√≠a:</strong> ${data.bateria}%<br>
                    <strong>üì° Fuente:</strong> ${data.fuente}
                </div>
            `;
            lastUpdate = timestamp;
        }

        function connectAsClient() {
            if (socket && socket.connected) {
                log('‚ö†Ô∏è Ya conectado como cliente');
                return;
            }

            log('üîå Conectando como CLIENTE con credenciales reales...');
            log(`üîë MicroId: ${CREDENTIALS.microId}`);
            log(`üîë Token: ${CREDENTIALS.token.substring(0, 50)}...`);

            // CR√çTICO: Usar la misma sintaxis que el chofer Flutter
            // SERVER_URL ya incluye el puerto, solo agregar /tracking
            const trackingUrl = `http://54.82.231.172:3001/tracking`;
            log(`üì° URL completa: ${trackingUrl}`);
            
            socket = io(trackingUrl, {
                auth: {
                    microId: CREDENTIALS.microId,
                    token: CREDENTIALS.token
                },
                transports: ['websocket', 'polling'],
                timeout: 10000,
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 2000
            });

            setupClientListeners();
        }

        function setupClientListeners() {
            if (!socket) return;

            socket.on('connect', () => {
                log(`‚úÖ Cliente conectado - Socket ID: ${socket.id}`);
                log(`üîç Namespace: ${socket.nsp}`);
                log(`üîç Connected: ${socket.connected}`);
                
                // CR√çTICO: Unirse a la ruta espec√≠fica
                log('üõ£Ô∏è Enviando joinRoute para Ruta B...');
                socket.emit('joinRoute', ROUTE_ID);
                log(`üõ£Ô∏è Evento joinRoute enviado para: ${ROUTE_ID}`);
            });

            socket.on('disconnect', (reason) => {
                log(`‚ùå Cliente desconectado: ${reason}`);
            });

            socket.on('connect_error', (error) => {
                log(`üî¥ Error de conexi√≥n: ${error.message}`);
                log(`üî¥ Descripci√≥n: ${error.description}`);
                log(`üî¥ Contexto: ${JSON.stringify(error.context)}`);
            });

            // DATOS INICIALES
            socket.on('initialTrackingData', (data) => {
                log(`üì¶ ‚≠ê RECIBIDO initialTrackingData: ${JSON.stringify(data).substring(0, 200)}...`);
                if (Array.isArray(data)) {
                    log(`üì¶ ‚≠ê ${data.length} micros en datos iniciales`);
                    data.forEach((micro, index) => {
                        log(`üì¶ ‚≠ê Micro ${index + 1}: ${micro.id_micro} - ${micro.latitud}, ${micro.longitud}`);
                    });
                    updateInitialData(data);
                }
            });

            // EVENTOS EN TIEMPO REAL - CR√çTICOS
            socket.on('locationUpdate', (data) => {
                log(`üåç ‚ö° LOCATION UPDATE GENERAL: ${JSON.stringify(data).substring(0, 150)}...`);
                log(`üîç microId: ${data?.id_micro}`);
                log(`üîç coordenadas: ${data?.latitud}, ${data?.longitud}`);
                log(`üîç timestamp: ${data?.updatedAt || 'no timestamp'}`);
                
                if (data?.id_micro === CREDENTIALS.microId) {
                    log(`üéØ ¬°UPDATE PARA NUESTRO MICRO!`);
                    updateRealtimeCoords(data);
                } else {
                    log(`üìç Update para otro micro: ${data?.id_micro}`);
                }
            });

            socket.on('routeLocationUpdate', (data) => {
                log(`üõ£Ô∏è ‚ö° ROUTE LOCATION UPDATE: ${JSON.stringify(data).substring(0, 150)}...`);
                log(`üîç microId: ${data?.id_micro}`);
                log(`üîç coordenadas: ${data?.latitud}, ${data?.longitud}`);
                log(`üîç ruta: ${data?.micro?.id_ruta}`);
                
                if (data?.id_micro === CREDENTIALS.microId) {
                    log(`üéØ ¬°ROUTE UPDATE PARA NUESTRO MICRO!`);
                    updateRealtimeCoords(data);
                } else {
                    log(`üìç Route update para otro micro: ${data?.id_micro}`);
                }
            });

            // CONFIRMACIONES DE UNI√ìN A RUTA
            socket.on('joinedRouteTracking', (data) => {
                log(`‚úÖ ‚≠ê CONFIRMACI√ìN: Unido al tracking de ruta: ${JSON.stringify(data)}`);
            });

            socket.on('leftRouteTracking', (data) => {
                log(`üëã ‚≠ê CONFIRMACI√ìN: Sali√≥ del tracking de ruta: ${JSON.stringify(data)}`);
            });

            // DEBUG: Escuchar TODOS los eventos
            socket.onAny((eventName, ...args) => {
                if (!['connect', 'disconnect'].includes(eventName)) {
                    log(`üîç EVENTO: ${eventName} - ${JSON.stringify(args).substring(0, 100)}...`);
                }
            });
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            isConnected = false;
            updateStatus('‚ùå Desconectado', false);
            log('üîå Desconectado manualmente');
        }

        function joinRoute() {
            if (!socket || !isConnected) {
                log('‚ö†Ô∏è No hay conexi√≥n activa');
                return;
            }

            log(`üõ£Ô∏è Uni√©ndose a ruta: ${CREDENTIALS.routeId}`);
            socket.emit('joinRoute', CREDENTIALS.routeId);
            log(`üì° Evento joinRoute enviado`);
        }

        function clearLog() {
            document.getElementById('eventLog').textContent = '';
            log('üßπ Log limpiado');
        }

        function updateInitialData(data) {
            const initialDataDiv = document.getElementById('initialData');
            let html = '<h3>üì¶ Datos Iniciales (Hist√≥ricos)</h3>';
            
            if (Array.isArray(data) && data.length > 0) {
                data.forEach(micro => {
                    const isTarget = micro.id_micro === CREDENTIALS.microId;
                    const targetClass = isTarget ? 'style="background: #004400; border: 2px solid #00ff00;"' : '';
                    const targetIcon = isTarget ? 'üéØ MONITOREADO' : '';
                    
                    html += `
                        <div ${targetClass} style="margin: 10px 0; padding: 10px; border: 1px solid #333;">
                            <strong>${micro.micro?.placa || 'N/A'} ${targetIcon}</strong><br>
                            ID: ${micro.id_micro}<br>
                            Lat: ${micro.latitud}, Lng: ${micro.longitud}<br>
                            √öltima actualizaci√≥n: ${new Date(micro.updatedAt || micro.createdAt).toLocaleString()}<br>
                            Bater√≠a: ${micro.bateria}% | Fuente: ${micro.fuente}
                        </div>
                    `;
                });
            } else {
                html += '<p>No hay datos iniciales disponibles</p>';
            }
            
            initialDataDiv.innerHTML = html;
        }

        function updateRealtimeCoords(data) {
            const realtimeDiv = document.getElementById('realtimeData');
            const timestamp = new Date().toLocaleString();
            
            const newUpdate = `
                <div style="margin: 5px 0; padding: 8px; background: #003300; border-left: 3px solid #00ff00;">
                    <strong>üöå ${data.micro?.placa || 'ABC123'}</strong> - ${timestamp}<br>
                    üìç Lat: ${data.latitud}, Lng: ${data.longitud}<br>
                    üîã Bater√≠a: ${data.bateria}% | üì° Fuente: ${data.fuente}<br>
                    üéØ Precisi√≥n: ${data.precision}m | üìè Altura: ${data.altura}m
                </div>
            `;
            
            // Agregar al inicio para mostrar las m√°s recientes primero
            realtimeDiv.innerHTML = newUpdate + realtimeDiv.innerHTML;
            
            // Mantener solo las √∫ltimas 10 actualizaciones
            const updates = realtimeDiv.children;
            while (updates.length > 10) {
                realtimeDiv.removeChild(updates[updates.length - 1]);
            }
        }

        // Auto-conectar al cargar la p√°gina
        window.addEventListener('load', () => {
            log('üöÄ Test de cliente iniciado');
            log('üìã Este test verificar√° si puede escuchar coordenadas en tiempo real');
            log('‚ö° Presiona "Conectar como Cliente" para empezar');
        });

        // Heartbeat cada 15 segundos
        setInterval(() => {
            if (socket && isConnected) {
                log(`üíì HEARTBEAT: Cliente conectado - ${new Date().toLocaleTimeString()}`);
                if (lastUpdate) {
                    log(`üìç √öltima actualizaci√≥n: ${lastUpdate}`);
                }
            }
        }, 15000);
    </script>
</body>
</html> 